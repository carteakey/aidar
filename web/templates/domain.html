{% extends "base.html" %}
{% block title %}{{ domain }} — aidar.lol{% endblock %}

{% set score = stats.avg_score | int %}
{% if score >= 65 %}{% set og_label = "LIKELY AI" %}
{% elif score >= 35 %}{% set og_label = "MIXED SIGNALS" %}
{% else %}{% set og_label = "MOSTLY HUMAN" %}{% endif %}

{% block head %}
<meta property="og:type" content="website">
<meta property="og:site_name" content="aidar.lol">
<meta property="og:title" content="{{ domain }} scores {{ score }}/100 on aidar.lol">
<meta property="og:description" content="{{ og_label }} — {{ stats.scans }} pages scanned. Track AI-era stylistic drift across the web.">
<meta property="og:image" content="https://aidar.lol/og/{{ domain }}">
<meta property="og:url" content="https://aidar.lol/domain/{{ domain }}">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ domain }} scores {{ score }}/100 on aidar.lol">
<meta name="twitter:description" content="{{ og_label }} — {{ stats.scans }} pages scanned. Is the internet writing itself yet?">
<meta name="twitter:image" content="https://aidar.lol/og/{{ domain }}">
{% endblock %}

{% block content %}

<div class="domain-hero">
  <div class="domain-name">{{ domain }}</div>
  <div class="domain-meta">
    {{ stats.scans }} pages scanned &nbsp;&middot;&nbsp;
    last updated {{ stats.latest[:10] if stats.latest else '—' }}
    {% if percentile is defined %}
    &nbsp;&middot;&nbsp;
    <span class="{% if percentile >= 0.65 %}c-red{% elif percentile >= 0.35 %}c-yellow{% else %}c-green{% endif %}">
      top {{ ((1 - percentile) * 100) | int }}% of corpus
    </span>
    {% endif %}
  </div>
  <div class="domain-actions" style="margin-top:0.75rem; display:flex; gap:1rem; align-items:center; flex-wrap:wrap;">
    <a class="share-btn"
       href="https://x.com/intent/tweet?text={{ domain }}+scores+{{ score }}%2F100+on+aidar.lol+%E2%80%94+{{ og_label | urlencode }}&url=https%3A%2F%2Fairdar.lol%2Fdomain%2F{{ domain | urlencode }}&via=carteakey"
       target="_blank" rel="noopener">↗ share on X</a>
    <span class="c-dim" style="font-size:0.75rem">embed:
      <code style="font-size:0.7rem; color:var(--fg-dim)">![aidar](https://aidar.lol/badge/{{ domain }})</code>
    </span>
  </div>
</div>

{% set score = stats.avg_score | int %}
{% if score >= 65 %}
  {% set color = "c-red" %}
  {% set bar_color = "#f87171" %}
{% elif score >= 35 %}
  {% set color = "c-yellow" %}
  {% set bar_color = "#facc15" %}
{% else %}
  {% set color = "c-green" %}
  {% set bar_color = "#4ade80" %}
{% endif %}

<div class="metric-grid">
  <div class="metric-cell">
    <div class="metric-value {{ color }}">{{ stats.avg_score }}</div>
    <div class="metric-label">avg index</div>
  </div>
  <div class="metric-cell">
    <div class="metric-value">{{ stats.max_score }}</div>
    <div class="metric-label">peak</div>
  </div>
  <div class="metric-cell">
    <div class="metric-value">{{ stats.min_score }}</div>
    <div class="metric-label">floor</div>
  </div>
  <div class="metric-cell">
    <div class="metric-value">{{ stats.scans }}</div>
    <div class="metric-label">pages</div>
  </div>
  <div class="metric-cell">
    <div class="metric-value c-red">{{ stats.label_counts.get('LIKELY AI', 0) }}</div>
    <div class="metric-label">high index</div>
  </div>
  <div class="metric-cell">
    <div class="metric-value c-green">{{ stats.label_counts.get('LIKELY HUMAN', 0) }}</div>
    <div class="metric-label">low index</div>
  </div>
</div>

{% if trend and trend | length > 1 %}
<div class="section-header" style="margin-top:2rem">
  <span class="section-title">score over time (by publish date)</span>
  <span class="c-dim" style="font-size:0.75rem">{{ trend | length }} dated articles</span>
</div>
<div style="display:flex; align-items:flex-end; gap:3px; height:60px; margin-bottom:2rem;">
  {% for row in trend %}
  {% set s = row.score %}
  {% if s >= 30 %}{% set bc = "#f87171" %}
  {% elif s >= 15 %}{% set bc = "#facc15" %}
  {% else %}{% set bc = "#4ade80" %}{% endif %}
  <div title="{{ row.published_date }}: {{ s }}/100{{ ' — ' + row.title if row.title else '' }}"
    style="flex:1; background:{{ bc }}; height:{{ [s * 2, 4] | max }}px; min-width:4px; opacity:0.8; cursor:default;"></div>
  {% endfor %}
</div>
{% endif %}

{% if scans %}
<!-- avg category breakdown from most recent scans -->
{% set recent = scans[:20] %}
{% set cat_keys = ['phrases', 'punctuation', 'structure', 'vocabulary', 'emoji'] %}
{% set cat_avgs = {} %}
{% for cat in cat_keys %}
  {% set vals = [] %}
  {% for s in recent if s.categories %}
    {% if s.categories[cat] is defined %}
      {% set _ = vals.append(s.categories[cat]) %}
    {% endif %}
  {% endfor %}
  {% if vals %}
    {% set _ = cat_avgs.update({cat: (vals | sum / vals | length)}) %}
  {% endif %}
{% endfor %}

{% if cat_avgs %}
<div class="section-header" style="margin-top:2rem">
  <span class="section-title">signal breakdown (avg, recent {{ recent|length }} pages)</span>
</div>
<div class="cat-grid">
  {% for cat in cat_keys %}
  {% set v = cat_avgs.get(cat, 0) %}
  {% if v >= 0.65 %}{% set bc = "#f87171" %}
  {% elif v >= 0.35 %}{% set bc = "#facc15" %}
  {% else %}{% set bc = "#4ade80" %}{% endif %}
  <div class="cat-row">
    <span class="cat-name">{{ cat }}</span>
    <div class="cat-bar">
      <div class="cat-bar-fill" style="width:{{ (v * 100) | int }}%; background:{{ bc }};"></div>
    </div>
    <span style="font-size:0.8rem; color:{{ bc }};">{{ "%.2f"|format(v) }}</span>
  </div>
  {% endfor %}
</div>
{% endif %}

<div class="section-header" style="margin-top:2rem">
  <span class="section-title">recent pages</span>
</div>

<table class="data-table">
  <thead>
    <tr>
      <th>url</th>
      <th>index</th>
      <th>words</th>
      <th>scanned</th>
    </tr>
  </thead>
  <tbody>
    {% for scan in scans %}
    {% set s = scan.score %}
    {% if s >= 65 %}{% set sc = "c-red" %}{% set bc = "#f87171" %}
    {% elif s >= 35 %}{% set sc = "c-yellow" %}{% set bc = "#facc15" %}
    {% else %}{% set sc = "c-green" %}{% set bc = "#4ade80" %}{% endif %}
    <tr>
      <td style="max-width:420px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
        <a href="{{ scan.url }}" target="_blank" title="{{ scan.url }}">
          {{ scan.url | replace('https://', '') | replace('http://', '') }}
        </a>
      </td>
      <td>
        <div class="score-bar-wrap">
          <div class="score-bar" style="width:50px">
            <div class="score-bar-fill" style="width:{{ s }}%; background:{{ bc }};"></div>
          </div>
          <span class="{{ sc }}" style="font-weight:bold">{{ s }}</span>
        </div>
      </td>
      <td class="c-dim">{{ scan.word_count }}</td>
      <td class="c-dim" style="font-size:0.75rem">{{ scan.scanned_at[:10] if scan.scanned_at else '—' }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}

{% endblock %}
